Kubernetes Cluster Setup Guide (Ubuntu)
This guide walks through setting up a single-node Kubernetes cluster on Ubuntu using containerd as the container runtime and Calico as the CNI plugin.
1. System Preparation
Update system packages:

sudo apt update && sudo apt upgrade -y

Enable IP forwarding:

cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.ipv4.ip_forward = 1
EOF
sudo sysctl --system

Disable swap:

sudo swapoff -a

sudo nano /etc/fstab   # comment out swap entry to make it permanent

2. Install Docker (for containerd runtime)
Install required packages:

sudo apt-get install -y ca-certificates curl gpg apt-transport-https
Add Docker’s official GPG key:
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

Add Docker repository:
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

Install Docker & containerd:
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

3. Configure containerd
Generate default config:

sudo containerd config default | sudo tee /etc/containerd/config.toml
Edit /etc/containerd/config.toml and set:
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
  SystemdCgroup = true
Restart containerd:
sudo systemctl restart containerd

4. Install Kubernetes Components
Add Kubernetes repository:

sudo curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg

echo "deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /" | sudo tee /etc/apt/sources.list.d/kubernetes.list
Install kubelet, kubeadm, kubectl:
sudo apt-get update
sudo apt-get install -y kubelet kubeadm kubectl
sudo apt-mark hold kubelet kubeadm kubectl
Enable kubelet:
sudo systemctl enable --now kubelet

till here for nodes only

5. Initialize Kubernetes Cluster

Run kubeadm init:
sudo kubeadm init
Configure kubectl for the current user:
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config

6. Install CNI Plugin (Calico)

Install Calico networking plugin:
kubectl apply -f https://docs.projectcalico.org/manifests/calico.yaml

7. Verify Setup
Check nodes:

kubectl get nodes
Check system pods:
kubectl get pods -n kube-system –watch
kubectl get pods --all-namespaces
kubectl get pods -A

for token..

kubeadm token create --print-join-command

All pods should eventually be in Running state.

For load balancing on selfhosted cluster do this

kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.5/config/manifests/metallb-native.yaml
kubectl -n metallb-system get pods


Create metallb-config.yaml

apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: default-pool
  namespace: metallb-system
spec:
  addresses:
    - 192.168.31.200-192.168.31.220   # <— choose free IPs on your LAN
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: default-advert
  namespace: metallb-system

kubectl apply -f metallb-config.yaml

kubectl get svc nginx

kubectl describe svc nginx

kubectl -n metallb-system get ipaddresspools,l2advertisements
kubectl -n metallb-system get events --sort-by=.lastTimestamp
kubectl -n metallb-system logs deploy/controller -f
kubectl -n metallb-system logs ds/speaker -f
